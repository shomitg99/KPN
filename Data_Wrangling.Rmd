---
title: "Data_Wrangling"
author: "Shomit Ghosh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file is a compilation of all the data wrangling steps (start to finish) that I've taken so far - no descriptives included here (as those will likely have to be redone). Here are the list of files you will need to replicate the process:

-   campaigns_served.csv
-   campaign_metadata.csv
-   customer_features.csv
-   current_var_names.xlsx
-   Income_and_Density.RData
-   EducationTable2.RData
-   AgeTable2.RData
-   Market_Size_Proxy.RData
-   variable_names.xlsx

**Loading necessary packages**

```{r, message = FALSE, warning = FALSE}
library(dplyr)
library(data.table)
library(readxl)
library(caret)
library(lubridate)
```

**Data Wrangling**

1.  Load raw KPN data (campaigns served, campaign metadata, and customer features)

    ```{r}
    nba_served <- fread("campaigns_served.csv")
    nba_meta <- fread("campaign_metadata.csv")
    customers <- fread("customer_features.csv")
    ```

2.  Renaming customer feature columns

    ```{r}
    new_var_names <- read_xlsx("current_var_names.xlsx")[,2]
    colnames(customers) <- new_var_names$new
    customers$date <- as.Date(customers$date) # Just for good measure
    ```

3.  Market leaders table

    ```{r}
    mkt_leaders <- data.frame(table(customers$historic_serviceProvider, customers$customer_province))
    mkt_leaders <- mkt_leaders[mkt_leaders$Var2 != "-",]
    colnames(mkt_leaders) <- c("mkt_leader", "customer_province", "Frequency")
    mkt_leaders <- mkt_leaders[mkt_leaders$mkt_leader != "-",]

    mkt_final <- mkt_leaders %>%
      group_by(customer_province) %>%
      slice(which.max(Frequency)) %>%
      select(customer_province, mkt_leader = mkt_leader)
    ```

4.  Create a variable 'month' in customer features and campaigns served

    ```{r}
    customers$month <- month(customers$date)
    nba_served$month <- month(nba_served$decision_date)
    ```

5.  **Merge** campaigns served and customer features by 'idMonth' [a combination of 'customer_id' and 'month'

    ```{r}
    batch <- nba_served # Why batch? I was just testing a smaller sample and didn't wanna rename everything from batch to something else.
    batch$location_id <- ifelse(batch$location_id == "", NA, batch$location_id)
    sum(is.na(batch$location_id))
    batch <- na.omit(batch)

    batch$idMonth <- paste(batch$location_id, batch$month,sep = "")
    customers$idMonth <- paste(customers$customer_id, customers$month,sep = "")

    nba_cus <- merge(batch, customers, by = "idMonth")
    ```

6.  **Merge** (campaigns served and customer features) and campaign metadata using 'date_name' [a combination of 'nba_name' and 'decision_date']

    ```{r}
    nba_meta$extract_date <- format(as.Date(nba_meta$extract_date, format = "%d/%m/%Y"), "%Y-%m-%d")
    nba_meta$date_name <- paste(nba_meta$extract_date, nba_meta$nba_name, sep = "")
    nba_cus$date_chr <- as.character(nba_cus$decision_date)
    nba_cus$date_name <- paste(nba_cus$decision_date, nba_cus$nba_name, sep = "")

    full <- merge(nba_cus, nba_meta, by = "date_name")
    full <- data.frame(full)
    ```

7.  Convert string variables to factors

    ```{r}
    for (i in 1:length(full)) {
      if (is.character(full[,i])) {
        full[,i] <- as.factor(full[,i])
      }
    }
    ```

8.  Check frequency for "unknown" province values and remove business line/park observations

    ```{r}
    nrow(full[full$customer_province == "-",]) # only 2, drop
    full <- full[full$customer_province != "-",]

    full <- full[full$customer_BizPark != 1,]
    full <- full[full$BusinessLine != "CM_ZM",]
    ```

9.  Create 'reaction' variable based on 'delta_hlv' value [originally, these were positive, neutral, negative. However, after the feedback session with KPN, we will focus solely on 'Sale' and 'Churn'. According to Anastasia, 'Sale' can be approximated by delta_hlv $\geq$ 1000 and 'Churn' can be classified by delta_hlv $\leq$ 800. The rest can be classed as 'Neutral', however, this group will be excluded for the purposes of this study.

    ```{r}
    full2 <- full # Why? Because I working with many different files. Too late to change it now teehee
    full2$reaction <- ifelse(full2$delta_hlv < -800, "Churn", ifelse(full2$delta_hlv == 0, "No Effect", ifelse(full2$delta_hlv > 1000, "Sale", "Change Order")))
    full2$reaction <- as.factor(full2$reaction)

    # Add week variables
    full2$week_decision <- week(full2$decision_date)
    full2$week_reward <- week(full2$reward_date)
    ```

10. **Merging** external datasets (that we have so far - relating to provincial education, age, and income) and cleaning up

-   Load and prep external data (source: CBS)

```{r}
load("Income_and_Density.RData") # Merging will occur later
load("EducationTable2.RData")
load("AgeTable2.RData")
load("Market_Size_Proxy.RData")

inc_dens <- data3
prov_age <- result
prov_edu <- result1

full3 <- full2 # Same reason as before
rm(data3) # Cleaning up a bit
rm(result)
rm(result1)
```

-   Final columns selection (please check from the original column list to see if I've missed anything)

```{r}
fin_cols <- read_excel("variable_names.xlsx")
fin_cols <- fin_cols$colnames.full.

full4 <- full3[, fin_cols]
# colnames(full4$customer_presence) <- "competitor_presence"
```

-   Recode VAS variables such that if something is present, it is coded as 1 and 0 otherwise (empty)

```{r}
full4$VAS_ziggo <- ifelse(full4$VAS_ziggo != "-",1,0)
full4$VAS_kids <- ifelse(full4$VAS_kids != "-",1,0)
full4$VAS_viaplay <- ifelse(full4$VAS_viaplay != "-",1,0)
full4$VAS_espn <- ifelse(full4$VAS_espn != "-",1,0)
full4$VAS_disney <- ifelse(full4$VAS_disney != "-", 1, 0)
full4$VAS_hbo <- ifelse(full4$VAS_hbo != "-", 1,0)
full4$VAS_prime <- ifelse(full4$VAS_prime != "-",1,0)
full4$VAS_netflix <- ifelse(full4$VAS_netflix != "-",1,0)
full4$VAS_kpnpay <- ifelse(full4$VAS_kpnpay != "-",1,0)
full4$VAS_spotify <- ifelse(full4$VAS_spotify != "-",1,0)
full4$VAS_videoland <- ifelse(full4$VAS_videoland != "-",1,0)
full4$VAS_pluspakket <- ifelse(full4$VAS_pluspakket != "-",1,0)
```

-   Check for missing values. Here I'm adding new checks instead of removing all missing values

```{r}
na_check <- colMeans(is.na(full4))
na_check
```

Looking at these checks, indeed we might have to get rid of some columns before we discard the rows. Another point of discussion (esp. when competition is such a big focus of ours)

```{r}
dash <- apply(full4, 2, function(x) sum(x == "-"))
dash_prop <- dash/nrow(full4)
dash_check <- data.frame(Column = names(full4), Occurences = dash, NAs = dash_prop)
dash_check <- dash_check[order(-dash_check[,2]),]
dash_check

colEx <- c("competitor_status", "competitor")

# Drop competitor_status and competitor (85% missing)
full4 <- full4[, -which(names(full4) %in% colEx)]

# Drop 2-7% missing
full4 <- full4[full4$BB_customerDuration != "-",]
full4 <- full4[full4$customer_urban_pop != "-",]
```

```{r}
blank <- apply(full4, 2, function(x) sum(x == ""))
blank_prop <- blank/nrow(full4)
blank_check <- data.frame(Column = names(full4), Occurences = blank, NAs = blank_prop)
blank_check <- blank_check[order(-blank_check[,2]),]
blank_check
```

```{r}
negOne <- apply(full4, 2, function(x) sum(x == -1))
negOne_prop <- negOne/nrow(full4)
negOne_check <- data.frame(Column = names(full4), Occurences = negOne, NAs = negOne_prop)
negOne_check <- negOne_check[order(-negOne_check[,2]),]
negOne_check

# mob_loc_total (convert -1 to 0, and drop 14)
full4$mob_loc_total <- ifelse(full4$mob_loc_total == -1, 0, full4$mob_loc_total)
full4 <- full4[full4$mob_loc_total != 14,]
```

```{r}
onb <- apply(full4, 2, function(x) sum(x == "0 - Onbekend"))
onb_prop <- onb/nrow(full4)
onb_check <- data.frame(Column = names(full4), Occurences = onb, NAs = onb_prop)
onb_check <- onb_check[order(-onb_check[,2]),]
onb_check

# 1.8% 0 - Onbekend (drop)
full4 <- full4[full4$customer_householdSize != "0 - Onbekend",]
```

```{r}
# Drop historic_serviceProvider (this was used to define market leaders)
full4 <- full4[, !(names(full4) %in% c("historic_serviceProvider"))]
```

**Merge** external datasets

```{r}
# merge - age
prov_age <- data.frame(
  "customer_province" = levels(full4$customer_province)
)
full4$customer_province <- droplevels(full4$customer_province)
prov_age$median_age <- c(2,2,2,1,1,2,1,2,1,2,2,2)



numeric_part <- as.numeric(sub("^\\D*(\\d+).*", "\\1", levels(full4$customer_age)))
ordLev <- levels(full4$customer_age)[order(numeric_part)]
full4$customer_age <- factor(full4$customer_age, levels = ordLev)
full4$age_2545 <- ifelse(as.numeric(full4$customer_age) >= 2 & as.numeric(full4$customer_age) <= 5, 1, 0)
full4$age_4565 <- ifelse(as.numeric(full4$customer_age) >= 6 & as.numeric(full4$customer_age) <= 9, 1, 0)
full4_1 <- merge(full4, prov_age, by = "customer_province")

# merge external - income and population density
colnames(inc_dens) <- c("customer_province", "social_dens","mean_income")
inc_dens$mean_income <- ifelse(inc_dens$mean_income < 50 & inc_dens$mean_income > 35, "4 - 35.000 - 50.000 euro", inc_dens$mean_income)
inc_dens$mean_income <- ifelse(inc_dens$mean_income < 70 & inc_dens$mean_income > 50, "5 - 50.000 - 75.000 euro", inc_dens$mean_income)

full5 <- merge(full4_1, inc_dens, by = "customer_province")

# merge external - education (+ adjust main education levels - drop 2,3,1)
full6 <- full5[full5$customer_education != "1 - Basisonderwijs",]
full7 <- full6[full6$customer_education != "2 - LBO / VMBO (kader of beroep) / MBO1",]
full8 <- full7[full7$customer_education != "3 - MAVO / MULO / VMBO (theoretisch of gemengd)",]

colnames(prov_edu) <- c("customer_province", "irrel","median_education","irrel2")
prov_edu <- prov_edu[,c(1,3)]
prov_edu$median_education <- as.factor(prov_edu$median_education)

prov_edu2 <- prov_edu %>%
  mutate(median_education = recode(median_education, "MBO Education" = 4, "VO Education" = 5))


full9 <- merge(full8, prov_edu2, by = "customer_province")

# external - diff
full9$edu_diff <- ifelse(as.numeric(full9$customer_education) != full9$median_education, 1, 0)
full9$inc_diff <- ifelse(full9$customer_income != full9$mean_income, 1, 0)
full9$age_diff <- ifelse(full9$age_2545 == 1 & full9$median_age == 1, 0, ifelse(full9$age_4565 == 1 & full9$median_age == 2,0,1))

# market size addition
colnames(MarketSizeData) <- c("customer_province", "mktSize_proxy")
full10 <- merge(full9, MarketSizeData, by = "customer_province")
```

Missing values dealt with! Now, new variables (competition-related) and strategic goals

```{r}
# convert household to numeric
full10$customer_householdSize <- as.numeric(full10$customer_householdSize) -2
full10$potential_mob_comp_pos <- ifelse(full10$customer_householdSize > full10$mob_loc_total, 1, 0)
full10$potential_mob_comp_neg <- ifelse(full10$customer_householdSize < full10$mob_loc_total, 1, 0)
```

```{r}
table(full10$StrategicGoal)
# Acquisition (Acq-BB, Acq-Mob), Customer Satisfaction (Service - CTR, Move - Service), Churn (Churn-BB, Move-Churn-BB, Retention BB, Retention-Mob), Upsell (Upsell-bundlemob, Upsell-TVVAS), Xsell (Xsell-BB, Xsell-Mob),  ARPU
full10$StrategicGoal <- as.character(full10$StrategicGoal)


full10$strat_new <- ifelse(full10$StrategicGoal == "Acq-BB" | full10$StrategicGoal == "Acq-Mob", "Acquisition", ifelse(full10$StrategicGoal == "Service-CTR" | full10$StrategicGoal == "Move-Service", "Satisfaction",ifelse(full10$StrategicGoal == "Churn-BB" | full10$StrategicGoal == "Move-Churn-BB" | full10$StrategicGoal == "Retention-BB" | full10$StrategicGoal == "Retention-Mob", "Churn",ifelse(full10$StrategicGoal == "Upsell-bundleMob" | full10$StrategicGoal == "Upsell-TVVAS", "Upsell",ifelse(full10$StrategicGoal == "Xsell-BB" | full10$StrategicGoal == "Xsell-Mob", "Xsell", "ARPU")))))

table(full10$strat_new)

full10$strat_new <- as.factor(full10$strat_new)

# Focus on Acquisition, Churn, Xsell, Upsell
full11 <- subset(full10, subset = strat_new == "Acquisition" | strat_new == "Churn" | strat_new == "Xsell" | strat_new == "Upsell")

table(full11$strat_new)

# market leaders
full12 <- merge(full11, mkt_final, by = "customer_province")


acq <- subset(full12, subset = strat_new == "Acquisition")
churn <- subset(full12, subset = strat_new == "Churn")
xsell <- subset(full12, subset = strat_new == "Xsell")
upsell <- subset(full12, subset = strat_new == "Upsell")

save(full12, file = "cleaned.RData")
save(acq, file = "acq.RData")
save(churn, file = "churn.RData")
save(xsell, file = "xsell.RData")
save(upsell, file = "upsell.RData")
```
