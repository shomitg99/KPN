---
title: "Data_Wrangling"
author: "Shomit Ghosh"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This file is a compilation of all the data wrangling steps (start to finish) that I've taken so far - no descriptives included here (as those will likely have to be redone). Here are the list of files you will need to replicate the process:

-   campaigns_served.csv
-   campaign_metadata.csv
-   customer_features.csv
-   current_var_names.xlsx
-   Income_and_Density.RData
-   EducationTable2.RData
-   AgeTable2.RData
-   Market_Size_Proxy.RData
-   variable_names.xlsx

**Loading necessary packages**

```{r, message = FALSE, warning = FALSE}
library(dplyr)
library(data.table)
library(readxl)
library(caret)
library(lubridate)
```

**Data Wrangling**

1.  Load raw KPN data (campaigns served, campaign metadata, and customer features)

    ```{r}
    nba_served <- fread("campaigns_served.csv")
    nba_meta <- fread("campaign_metadata.csv")
    customers <- fread("customer_features.csv")
    ```

2.  Renaming customer feature columns

    ```{r}
    new_var_names <- read_xlsx("current_var_names.xlsx")[,2]
    colnames(customers) <- new_var_names$new
    customers$date <- as.Date(customers$date) # Just for good measure
    ```

3.  Create a variable 'month' in customer features and campaigns served

    ```{r}
    customers$month <- month(customers$date)
    nba_served$month <- month(nba_served$decision_date)
    ```

4.  **Merge** campaigns served and customer features by 'idMonth' [a combination of 'customer_id' and 'month'

    ```{r}
    batch <- nba_served # Why batch? I was just testing a smaller sample and didn't wanna rename everything from batch to something else.
    batch$location_id <- ifelse(batch$location_id == "", NA, batch$location_id)
    sum(is.na(batch$location_id))
    batch <- na.omit(batch)

    batch$idMonth <- paste(batch$location_id, batch$month,sep = "")
    customers$idMonth <- paste(customers$customer_id, customers$month,sep = "")

    nba_cus <- merge(batch, customers, by = "idMonth")
    ```

5.  **Merge** (campaigns served and customer features) and campaign metadata using 'date_name' [a combination of 'nba_name' and 'decision_date']

    ```{r}
    nba_meta$extract_date <- format(as.Date(nba_meta$extract_date, format = "%d/%m/%Y"), "%Y-%m-%d")
    nba_meta$date_name <- paste(nba_meta$extract_date, nba_meta$nba_name, sep = "")
    nba_cus$date_chr <- as.character(nba_cus$decision_date)
    nba_cus$date_name <- paste(nba_cus$decision_date, nba_cus$nba_name, sep = "")

    full <- merge(nba_cus, nba_meta, by = "date_name")
    full <- data.frame(full)
    ```

6.  Convert string variables to factors

    ```{r}
    for (i in 1:length(full)) {
      if (is.character(full[,i])) {
        full[,i] <- as.factor(full[,i])
      }
    }
    ```

7.  Check frequency for "unknown" province values and remove business line/park observations

    ```{r}
    nrow(full[full$customer_province == "-",]) # only 2, drop
    full <- full[full$customer_province != "-",]

    full <- full[full$customer_BizPark != 1,]
    full <- full[full$BusinessLine != "CM_ZM",]
    ```

8.  Create 'reaction' variable based on 'delta_hlv' value [originally, these were positive, neutral, negative. However, after the feedback session with KPN, we will focus solely on 'Sale' and 'Churn'. According to Anastasia, 'Sale' can be approximated by delta_hlv $\geq$ 1000 and 'Churn' can be classified by delta_hlv $\leq$ 800. The rest can be classed as 'Neutral', however, this group will be excluded for the purposes of this study.

    ```{r}
    full2 <- full # Why? Because I working with many different files. Too late to change it now teehee
    full2$reaction <- ifelse(full2$delta_hlv < -800, "Churn", ifelse(full2$delta_hlv == 0, "No Effect", ifelse(full2$delta_hlv > 1000, "Sale", "Change Order")))
    full2$reaction <- as.factor(full2$reaction)

    # Add week variables
    full2$week_decision <- week(full2$decision_date)
    full2$week_reward <- week(full2$reward_date)
    ```

9.  **Merging** external datasets (that we have so far - relating to provincial education, age, and income) and cleaning up

-   Load and prep external data (source: CBS)

```{r}
load("Income_and_Density.RData") # Merging will occur later
load("EducationTable2.RData")
load("AgeTable2.RData")
load("Market_Size_Proxy.RData")

inc_dens <- data3
prov_age <- result
prov_edu <- result1

full3 <- full2 # Same reason as before
rm(data3) # Cleaning up a bit
rm(result)
rm(result1)
```

-   Final columns selection (please check from the original column list to see if I've missed anything)

```{r}
fin_cols <- read_excel("variable_names.xlsx")
fin_cols <- fin_cols$colnames.full.

full4 <- full3[, fin_cols]
# colnames(full4$customer_presence) <- "competitor_presence"
```

-   Recode VAS variables such that if something is present, it is coded as 1 and 0 otherwise (empty)

```{r}
full4$VAS_ziggo <- ifelse(full4$VAS_ziggo != "-",1,0)
full4$VAS_kids <- ifelse(full4$VAS_kids != "-",1,0)
full4$VAS_viaplay <- ifelse(full4$VAS_viaplay != "-",1,0)
full4$VAS_espn <- ifelse(full4$VAS_espn != "-",1,0)
full4$VAS_disney <- ifelse(full4$VAS_disney != "-", 1, 0)
full4$VAS_hbo <- ifelse(full4$VAS_hbo != "-", 1,0)
full4$VAS_prime <- ifelse(full4$VAS_prime != "-",1,0)
full4$VAS_netflix <- ifelse(full4$VAS_netflix != "-",1,0)
full4$VAS_kpnpay <- ifelse(full4$VAS_kpnpay != "-",1,0)
full4$VAS_spotify <- ifelse(full4$VAS_spotify != "-",1,0)
full4$VAS_videoland <- ifelse(full4$VAS_videoland != "-",1,0)
full4$VAS_pluspakket <- ifelse(full4$VAS_pluspakket != "-",1,0)
```

-   Check for missing values. Here I'm adding new checks instead of removing all missing values

```{r}
na_check <- colMeans(is.na(full4))
na_check
```

Looking at these checks, indeed we might have to get rid of some columns before we discard the rows. Another point of discussion (esp. when competition is such a big focus of ours)

```{r}
dash <- apply(full4, 2, function(x) sum(x == "-"))
dash_prop <- dash/nrow(full4)
dash_check <- data.frame(Column = names(full4), Occurences = dash, NAs = dash_prop)
dash_check <- dash_check[order(-dash_check[,2]),]
dash_check

colEx <- c("competitor_status", "competitor")

# Drop competitor_status and competitor (85% missing)
full4 <- full4[, -which(names(full4) %in% colEx)]

# Drop 2-7% missing
full4 <- full4[full4$BB_customerDuration != "-",]
full4 <- full4[full4$customer_urban_pop != "-",]
```

```{r}
blank <- apply(full4, 2, function(x) sum(x == ""))
blank_prop <- blank/nrow(full4)
blank_check <- data.frame(Column = names(full4), Occurences = blank, NAs = blank_prop)
blank_check <- blank_check[order(-blank_check[,2]),]
blank_check
```

```{r}
negOne <- apply(full4, 2, function(x) sum(x == -1))
negOne_prop <- negOne/nrow(full4)
negOne_check <- data.frame(Column = names(full4), Occurences = negOne, NAs = negOne_prop)
negOne_check <- negOne_check[order(-negOne_check[,2]),]
negOne_check
```

```{r}
onb <- apply(full4, 2, function(x) sum(x == "0 - Onbekend"))
onb_prop <- onb/nrow(full4)
onb_check <- data.frame(Column = names(full4), Occurences = onb, NAs = onb_prop)
onb_check <- onb_check[order(-onb_check[,2]),]
onb_check

# 1.8% 0 - Onbekend
```

```{r}
# Recoding historic_serviceProvider
full4$historic_serviceProvider <- ifelse(full4$historic_serviceProvider == "", "Unknown",ifelse(full4$historic_serviceProvider == "-", "Unknown", full4$historic_serviceProvider))
```

Missing values dealt with! Now, strategic goals

```{r}
table(full4$StrategicGoal)
# Acquisition (Acq-BB, Acq-Mob), Customer Satisfaction (Service - CTR, Move - Service), Churn (Churn-BB, Move-Churn-BB, Retention BB, Retention-Mob), Upsell (Upsell-bundlemob, Upsell-TVVAS), Xsell (Xsell-BB, Xsell-Mob),  ARPU
full4$StrategicGoal <- as.character(full4$StrategicGoal)


full4$strat_new <- ifelse(full4$StrategicGoal == "Acq-BB" | full4$StrategicGoal == "Acq-Mob", "Acquisition", ifelse(full4$StrategicGoal == "Service-CTR" | full4$StrategicGoal == "Move-Service", "Satisfaction",ifelse(full4$StrategicGoal == "Churn-BB" | full4$StrategicGoal == "Move-Churn-BB" | full4$StrategicGoal == "Retention-BB" | full4$StrategicGoal == "Retention-Mob", "Churn",ifelse(full4$StrategicGoal == "Upsell-bundleMob" | full4$StrategicGoal == "Upsell-TVVAS", "Upsell",ifelse(full4$StrategicGoal == "Xsell-BB" | full4$StrategicGoal == "Xsell-Mob", "Xsell", "ARPU")))))

table(full4$strat_new)

full4$strat_new <- as.factor(full4$strat_new)
table(full4$strat_new, full4$customer_province)
```


